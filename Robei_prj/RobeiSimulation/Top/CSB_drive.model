<!DOCTYPE Robei>
<Module Type="module" File="Current/CSB_dri.model" Comment="" Color="#d3d3d3" Y="0" Height="600" X="0" Name="CSB_drive" Code="//generate cnt_17K_en&#xa;//单比特跨时钟域处理，延时两拍&#xa;reg [2:0] Echo_delay;&#xa;always @ (posedge clk or negedge rst_n)begin&#xa;&#x9;&#x9;if(!rst_n)begin&#xa;  &#x9;&#x9;&#x9;Echo_delay &lt;= 1'd0;&#xa;&#x9;&#x9;end&#xa;&#x9;&#x9;else begin&#xa;&#x9;&#x9;&#x9;&#x9;Echo_delay &lt;= {Echo_delay[1:0],Echo}; //让Echo_delay的高位溢出，低位依次变成接收到的Echo&#xa;&#x9;&#x9;end&#xa;end &#xa;//检测上升沿下降沿&#xa;wire nege_Echo;&#xa;wire pose_Echo;&#xa;assign pose_Echo = (~Echo_delay[2])&amp;&amp;Echo_delay[1];&#xa;assign nege_Echo = Echo_delay[2]&amp;&amp;(!Echo_delay[1]);&#xa;&#xa;//产生计数使能信号，高电平期间开始计数，低电平期间停止计数&#xa;reg cnt_17K_en;&#xa;always @ (posedge clk or negedge rst_n)&#xa;begin&#xa; if(!rst_n)&#xa;  cnt_17K_en &lt;= 1'd0;&#xa; else &#xa;  if(pose_Echo)&#xa;   cnt_17K_en &lt;= 1'b1;&#xa;  else &#xa;   if(nege_Echo)&#xa;    cnt_17K_en &lt;= 1'b0;&#xa;   else &#xa;    cnt_17K_en &lt;= cnt_17K_en;&#xa;end&#xa;&#xa;&#xa;//产生17KHz计数器&#xa;reg [10:0] cnt_17K;&#xa;always @ (posedge clk or negedge rst_n)&#xa;begin&#xa; if(!rst_n)&#xa;  cnt_17K &lt;= 1'd0;&#xa; else &#xa;  if(cnt_17K_en)&#xa;   begin&#xa;    if(cnt_17K == 11'd1961)&#xa;    //if(cnt_17K == 11'd19)&#xa;     cnt_17K &lt;= 1'd0;&#xa;          else &#xa;           cnt_17K &lt;= cnt_17K + 1'b1;&#xa;   end&#xa;  else &#xa;   cnt_17K &lt;= 1'd0;&#xa;end &#xa;&#xa;//产生17KHz时钟&#xa;reg clk_17K;&#xa;always @ (posedge clk or negedge rst_n)&#xa;begin&#xa; if(!rst_n)&#xa;  clk_17K &lt;= 1'b0;&#xa; else &#xa;  if(cnt_17K == 11'd1961)&#xa;   // if(cnt_17K == 11'd19)&#xa;   clk_17K &lt;= 1'b1;&#xa;  else &#xa;   clk_17K &lt;= 1'b0;&#xa;end&#xa;&#xa;//产生500ms计数器&#xa;reg [22:0] cnt_500Ms;&#xa;always @ (posedge clk or negedge rst_n)&#xa;begin&#xa; if(!rst_n)&#xa;  cnt_500Ms &lt;= 1'b0;&#xa; else &#xa;   if(cnt_500Ms == 23'd8333333) //500ms&#xa;   //if(cnt_500Ms == 23'd5000)&#xa;   cnt_500Ms &lt;= 1'd0;&#xa;  else &#xa;   cnt_500Ms &lt;= cnt_500Ms + 1'b1;&#xa;end&#xa;&#xa;//产生10us高电平的脉冲&#xa;always @ (posedge clk or negedge rst_n)&#xa;begin&#xa; if(!rst_n)&#xa;  trig &lt;= 1'b0;&#xa; else &#xa;   if(cnt_500Ms &lt;= 23'd333) &#xa;   //if(cnt_500Ms &lt;= 23'd3)&#xa;   trig &lt;= 1'b1; //trig信号用于触发模块开始工作&#xa;  else &#xa;   trig &lt;= 1'b0;&#xa;end &#xa;&#xa;//显示部分，使用计数器进行计数（17KHz）&#xa;reg [15:0] data_r;&#xa;always @ (posedge clk or negedge rst_n)&#xa;begin&#xa; if(!rst_n)&#xa;  data_r &lt;= 1'd0;&#xa; else &#xa;  if(clk_17K == 1'b1)&#xa;   begin&#xa;    if(data_r[3 :0 ] == 4'd9)&#xa;     begin&#xa;      data_r[7 :4 ] &lt;= 1'b1 + data_r[7 :4 ];&#xa;      data_r[3 :0 ] &lt;= 1'd0;&#xa;     end &#xa;    else &#xa;     if(data_r[7 :4 ] == 4'd9)&#xa;      begin&#xa;       data_r[11:8 ] &lt;= 1'b1 + data_r[11:8 ];&#xa;       data_r[7 :4 ] &lt;= 1'd0;&#xa;      end &#xa;     else &#xa;      if(data_r[11:8 ] == 4'd9)&#xa;       begin&#xa;        data_r[15:12] &lt;= 1'b1 + data_r[15:12];&#xa;        data_r[11:8 ] &lt;= 1'd0;&#xa;       end &#xa;      else &#xa;       data_r &lt;= data_r + 1'b1;&#xa;   end &#xa;  else &#xa;   if(cnt_500Ms == 23'd8333333)&#xa;   //if(cnt_500Ms == 23'd5000)&#xa;    data_r &lt;= 1'd0;&#xa;   else&#xa;    data_r &lt;= data_r;&#xa;end &#xa;&#xa;&#xa;always @ (posedge clk or negedge rst_n)&#xa;begin&#xa; if(!rst_n)&#xa;  data &lt;= 1'd0;&#xa; else &#xa;   if(cnt_500Ms == 23'd8333332)&#xa;   //if(cnt_500Ms == 23'd4999)&#xa;   data &lt;= data_r;&#xa;  else &#xa;   data &lt;= data ;&#xa;end &#xa;&#xa;&#xa;&#xa;" Parent="0" Class="module" Width="900" Parameters="" Include="">
 <Port Side="left" Datasize="1" Inout="input" Color="#faebd7" Y="0.183333" Height="20" X="-0.0222222" Name="clk" Datatype="wire" Function="" Parent="CSB_drive" Width="20"/>
 <Port Side="left" Datasize="1" Inout="input" Color="#00ffff" Y="0.383333" Height="20" X="-0.0222222" Name="rst_n" Datatype="wire" Function="" Parent="CSB_drive" Width="20"/>
 <Port Side="left" Datasize="1" Inout="input" Color="#7fffd4" Y="0.583333" Height="20" X="-0.0222222" Name="Echo" Datatype="wire" Function="" Parent="CSB_drive" Width="20"/>
 <Port Side="right" Datasize="1" Inout="output" Color="#f0ffff" Y="0.233333" Height="20" X="0.977778" Name="trig" Datatype="reg" Function="" Parent="CSB_drive" Width="20"/>
 <Port Side="right" Datasize="16" Inout="output" Color="#f5f5dc" Y="0.483333" Height="20" X="0.977778" Name="data" Datatype="reg" Function="" Parent="CSB_drive" Width="20"/>
</Module>
