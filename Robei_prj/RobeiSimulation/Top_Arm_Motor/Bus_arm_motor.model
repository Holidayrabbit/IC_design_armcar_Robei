<!DOCTYPE Robei>
<Module Type="module" File="Current/Bus_arm_motor.model" Width="900" Code="&#x9;&#x9;/*&#xa;&#x9;&#x9;该模块负责串口指令的解析,分别输出对机械臂和电机的指令。&#xa;&#x9;&#x9;&#xa;&#x9;&#x9;定义串口指令：&#xa;&#x9;&#x9;帧头 0x55 和 0xA5 + 器件地址 + 功能码 + 数据（寄存器地址+有效数据） + 帧尾 0xF0   ，一共10字节&#xa;&#x9;&#x9;器件地址：机械臂0x00    电机0x34&#xa;&#x9;&#x9;功能码：第八位表示读或者写 低四位表示有效数据的长度&#xa;&#x9;&#x9;数据：&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;机械臂：XX 00 00 00 00&#x9;&#x9;&#x9;(XX高六位表示转动的舵机，低一位表示转动方向)&#x9;[47:40]&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;电机：&#x9;XX XX XX XX XX&#x9;&#x9;&#x9;（第一个字节表示寄存器地址，后面四个字节表示页写数据）&#xa;&#x9;&#x9;&#xa;&#x9;&#x9;综上，串口指令协议的长度为 10字节，我们所需做的就是对这10字节数据进行判断。&#xa;&#x9;&#x9;只要满足串口指令协议要求（即帧头 0x55+帧头 0xA5+19 字节内容+帧尾 0xF0），便代表是正确的串口指令。&#xa;&#x9;&#x9;随后从指令中提取出对应的起始地址、功能码、数据，并产生 cmd 有效信号（cmd_valid），发送个机械臂或者电机驱动模块。&#xa;&#x9;&#x9;&#xa;&#x9;&#x9;变量解释：&#xa;&#x9;&#x9;bus_rx_done（r_rx_done）来自buffer的信号，当buffer发送完毕，该信号变为1&#xa;&#x9;&#x9;&#xa;&#x9;&#x9;还需补充的内容：&#xa;&#x9;&#x9;buffer_empty&#xa;&#x9;&#x9;buffer_rd&#x9;&#x9;&#xa;&#x9;&#x9;*/&#xa;&#x9;&#x9;&#xa;&#x9;&#x9;&#x9;reg [7:0] data_str [9:0];&#x9;&#x9;//将从buffer收到的数据拼接成完整的串口帧&#xa;&#xa;&#xa;&#x9;&#x9;&#x9;always@(posedge Clk) begin&#xa;/*&#xa;&#x9;&#x9;&#x9;&#x9;if(buffer_empty)&#x9;&#x9;&#x9;//如果buffer空了就读取无效&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;cmd_valid &lt;= #1 0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;end&#xa;*/&#xa;&#xa;&#x9;&#x9;&#x9;&#x9;if(bus_rx_done)&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;//buffer_rd &lt;=  0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;data_str[9] &lt;= #1 instruction_data;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;data_str[8] &lt;= #1 data_str[9];&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;data_str[7] &lt;= #1 data_str[8];           &#xa;&#x9;&#x9;&#x9;&#x9;&#x9;data_str[6] &lt;= #1 data_str[7];&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;data_str[5] &lt;= #1 data_str[6];&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;data_str[4] &lt;= #1 data_str[5];&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;data_str[3] &lt;= #1 data_str[4];&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;data_str[2] &lt;= #1 data_str[3];&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;data_str[1] &lt;= #1 data_str[2];&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;data_str[0] &lt;= #1 data_str[1];&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;//buffer_rd &lt;=  1;&#x9;//读取完一个字节就申请再读一个字节&#xa;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;end&#x9;&#x9;&#xa;&#x9;&#x9;&#xa;&#x9;&#x9;&#x9;reg r_rx_done;&#xa;&#xa;&#x9;&#x9;    always@(posedge Clk) begin&#xa;&#x9;&#x9;//&#x9;if(buffer_empty)&#x9;&#x9;cmd_valid &lt;= #1 0;&#x9;//如果buffer空了就读取无效&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;    &#xa;&#x9;&#x9;&#x9;r_rx_done &lt;= bus_rx_done;&#xa;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;    &#xa;&#x9;&#x9;    always@(posedge Clk or negedge Rst_n)&#x9;//复位全部置为0&#xa;&#x9;&#x9;    if(!Rst_n) &#xa;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;//&#x9;&#x9;buffer_rd &lt;=  0;&#x9;//初始时刻，请求读取&#xa;&#x9;&#x9;        motor_reg_address &lt;= #1 0;&#xa;&#x9;&#x9;&#x9;&#x9;arm_id &lt;= #1 0;&#xa;&#x9;&#x9;&#x9;&#x9;arm_cmd &lt;= #1 0;&#xa;&#x9;&#x9;&#x9;&#x9;motor_cmd_data&lt;= #1 0;&#xa;&#x9;&#x9;        cmd_valid &lt;= #1 0;&#xa;&#x9;&#x9;        motor_num_cmd &lt;= #1 0;&#xa;&#x9;&#x9;&#x9;&#x9;&#xa;&#x9;&#x9;&#x9;&#x9;&#xa;&#x9;&#x9;&#x9;&#x9;end &#xa;&#x9;&#x9;&#x9;&#x9;&#xa;&#x9;&#x9;&#x9;else if(r_rx_done)&#xa;&#x9;&#x9;&#x9;&#x9;begin&#x9;&#x9;&#x9;//串口数据包全部收到了，开始解析命令&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;if((data_str[0] == 8'h55) &amp;&amp; (data_str[1] == 8'hA5) &amp;&amp; (data_str[9] == 8'hF0))&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;if(data_str[2] == 8'h00)&#x9;&#x9;//表示操作机械臂&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;arm_id &lt;= #1 data_str[4][7:5];&#x9;&#x9;//第五个字节高三位&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;arm_cmd &lt;= #1 data_str[4][0];&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_id &lt;= 0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_reg_address &lt;= 0;  //第五个字节&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_cmd_data&lt;= 0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_num_cmd &lt;= 0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;cmd_valid &lt;= #1 1;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;else if(data_str[2] == 8'h34)&#x9;//表示操作电机&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;arm_id&lt;=0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;arm_cmd &lt;= 0;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_id &lt;= #1 8'h34;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_reg_address &lt;= #1 data_str[4];  //第五个字节&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_cmd_data&lt;= #1 {data_str[5],data_str[6],data_str[7],data_str[8]};&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_num_cmd &lt;= #1 data_str[3];&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;cmd_valid &lt;= #1 1;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;else &#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;arm_id&lt;=0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;arm_cmd &lt;= 0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_id &lt;= 0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_reg_address &lt;= 0;  //第五个字节&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_cmd_data&lt;= 0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;motor_num_cmd &lt;= 0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;cmd_valid &lt;= #1 0;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;else&#x9;cmd_valid &lt;= #1 0;     " Color="#d3d3d3" Include="" Class="module" Height="600" X="0" Name="Bus_arm_motor" Parameters="" Comment="" Y="0" Parent="0">
 <Port Function="" Inout="input" Width="20" Color="#faebd7" Datatype="wire" Height="20" X="-0.0222222" Name="Clk" Side="left" Y="0.15" Datasize="1" Parent="Bus_arm_motor"/>
 <Port Function="" Inout="input" Width="20" Color="#00ffff" Datatype="wire" Height="20" X="-0.0222222" Name="Rst_n" Side="left" Y="0.316667" Datasize="1" Parent="Bus_arm_motor"/>
 <Port Function="" Inout="input" Width="20" Color="#7fffd4" Datatype="wire" Height="20" X="-0.0222222" Name="instruction_data" Side="left" Y="0.483333" Datasize="8" Parent="Bus_arm_motor"/>
 <Port Function="" Inout="output" Width="20" Color="#f5f5dc" Datatype="reg" Height="20" X="0.977778" Name="cmd_valid" Side="right" Y="0.0933333" Datasize="1" Parent="Bus_arm_motor"/>
 <Port Function="" Inout="output" Width="20" Color="#ffe4c4" Datatype="reg" Height="20" X="0.977778" Name="arm_id" Side="right" Y="0.203333" Datasize="8" Parent="Bus_arm_motor"/>
 <Port Function="" Inout="output" Width="20" Color="#b8860b" Datatype="reg" Height="20" X="0.977778" Name="arm_cmd" Side="right" Y="0.313333" Datasize="1" Parent="Bus_arm_motor"/>
 <Port Function="" Inout="output" Width="20" Color="#ffebcd" Datatype="reg" Height="20" X="0.977778" Name="motor_reg_address" Side="right" Y="0.423333" Datasize="8" Parent="Bus_arm_motor"/>
 <Port Function="" Inout="output" Width="20" Color="#0000ff" Datatype="reg" Height="20" X="0.977778" Name="motor_cmd_data" Side="right" Y="0.533333" Datasize="32" Parent="Bus_arm_motor"/>
 <Port Function="" Inout="output" Width="20" Color="#8a2be2" Datatype="reg" Height="20" X="0.977778" Name="motor_num_cmd" Side="right" Y="0.643333" Datasize="8" Parent="Bus_arm_motor"/>
 <Port Function="" Inout="output" Width="20" Color="#deb887" Datatype="reg" Height="20" X="0.977778" Name="motor_id" Side="right" Y="0.753333" Datasize="8" Parent="Bus_arm_motor"/>
 <Port Function="" Inout="input" Width="20" Color="#5f9ea0" Datatype="wire" Height="20" X="-0.0222222" Name="bus_rx_done" Side="left" Y="0.65" Datasize="1" Parent="Bus_arm_motor"/>
</Module>
