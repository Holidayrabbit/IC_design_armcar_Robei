<!DOCTYPE Robei>
<Module Height="600" Type="module" X="0" Y="0" Comment="" Width="900" Parameters="" Code="parameter DATA_WIDTH = 80;&#xa;parameter fill_data = 8'h55;&#xa;parameter delta_angle_low = 8'h53;//每次变化角度5°&#xa;parameter delta_angle_heigh = 8'h6;&#xa;parameter time_low = 8'hda;//0.1s一个动作&#xa;parameter time_heigh =8'h0; &#xa;reg [DATA_WIDTH-1:0] reg_out_data;&#xa;reg [7:0] angle_low [5:0];&#xa;reg [7:0] angle_heigh [5:0];&#xa;reg [7:0] reg_cal;////////////////&#xa;reg [7:0] med_angle;&#xa;reg [7:0] in_low;&#xa;reg [7:0] in_heigh;&#xa;reg [7:0] reg_id;&#xa;reg run_valid;&#xa;integer i;&#xa;&#xa;localparam S0 = 0;&#x9;//等待发送请求&#xa;localparam S1 = 1;&#x9;//计算数据发送&#xa;localparam S2 = 2;&#x9;//等待单字节数据发送完成&#xa;localparam S3 = 3;&#x9;//检查所有数据是否发送完成&#xa;&#xa;reg [1:0] state_cal;&#xa;always @(posedge Clk or negedge Rst_n)&#xa;begin&#xa;if (!Rst_n)&#xa;&#x9;begin&#xa;&#x9;for (i = 0 ; i &lt; 6; i = i + 1) begin&#xa;&#x9;&#x9;angle_low[i] &lt;= 8'h0;&#xa;&#x9;&#x9;angle_heigh[i] &lt;= 8'h0;&#xa;&#x9;&#x9;end&#xa;&#x9;med_angle &lt;= 8'h0;&#xa;&#x9;in_low &lt;= 8'h0;&#xa;&#x9;in_heigh &lt;= 8'h0;&#xa;&#x9;reg_id &lt;= 8'h0;&#xa;&#x9;state_cal &lt;= S0;&#xa;&#x9;reg_cal &lt;= 8'h0;&#xa;&#x9;end&#xa;else&#xa;&#x9;begin&#xa;&#x9;&#x9;//计算数据&#xa;&#x9;case(state_cal)&#xa;&#x9;S0:&#xa;&#x9;&#x9;begin&#xa;&#x9;&#x9;send_en_out &lt;= 1'b0;&#xa;&#x9;&#x9;if(input_id != 8'h0)&#xa;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;state_cal &lt;= S1;&#xa;&#x9;&#x9;&#x9;reg_id &lt;= input_id;&#xa;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;end&#xa;&#x9;S1:&#xa;&#x9;&#x9;begin&#xa;&#x9;&#x9;case(reg_id)&#xa;&#x9;&#x9;&#x9;8'h1:&#xa;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[0];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[0]; &#xa;&#x9;&#x9;&#x9;&#x9;if (input_cmd)  //加法 ??????????阻塞or非阻塞,顺时针&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;add_model(in_low,in_heigh,angle_low[0],angle_heigh[0]);&#xa;&#x9;&#x9;&#x9;&#x9;else &#xa;&#x9;&#x9;&#x9;&#x9;&#x9;sub_model(in_low,in_heigh,angle_low[0],angle_heigh[0]);&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[0];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[0]; &#xa;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;8'h2:&#xa;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[1];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[1]; &#xa;&#x9;&#x9;&#x9;&#x9;if (input_cmd) &#xa;&#x9;&#x9;&#x9;&#x9;&#x9;add_model(in_low,in_heigh,angle_low[1],angle_heigh[1]);&#xa;&#x9;&#x9;&#x9;&#x9;else &#xa;&#x9;&#x9;&#x9;&#x9;&#x9;sub_model(in_low,in_heigh,angle_low[1],angle_heigh[1]);&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[1];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[1]; &#xa;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;8'h3:&#xa;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[2];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[2]; &#xa;&#x9;&#x9;&#x9;&#x9;if (input_cmd)&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;add_model(in_low,in_heigh,angle_low[2],angle_heigh[2]);&#xa;&#x9;&#x9;&#x9;&#x9;else &#xa;&#x9;&#x9;&#x9;&#x9;&#x9;sub_model(in_low,in_heigh,angle_low[2],angle_heigh[2]);&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[2];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[2]; &#xa;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;8'h4:&#xa;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[3];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[3]; &#xa;&#x9;&#x9;&#x9;&#x9;if (input_cmd) &#xa;&#x9;&#x9;&#x9;&#x9;&#x9;add_model(in_low,in_heigh,angle_low[3],angle_heigh[3]);&#xa;&#x9;&#x9;&#x9;&#x9;else &#xa;&#x9;&#x9;&#x9;&#x9;&#x9;sub_model(in_low,in_heigh,angle_low[3],angle_heigh[3]);&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[3];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[3]; &#xa;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;8'h5:&#xa;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[4];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[4]; &#xa;&#x9;&#x9;&#x9;&#x9;if (input_cmd)&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;add_model(in_low,in_heigh,angle_low[4],angle_heigh[4]);&#xa;&#x9;&#x9;&#x9;&#x9;else &#xa;&#x9;&#x9;&#x9;&#x9;&#x9;sub_model(in_low,in_heigh,angle_low[4],angle_heigh[4]);&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[4];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[4]; &#xa;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;8'h6:&#xa;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[5];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[5]; &#xa;&#x9;&#x9;&#x9;&#x9;if (input_cmd)&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;add_model(in_low,in_heigh,angle_low[5],angle_heigh[5]);&#xa;&#x9;&#x9;&#x9;&#x9;else &#xa;&#x9;&#x9;&#x9;&#x9;&#x9;sub_model(in_low,in_heigh,angle_low[5],angle_heigh[5]);&#xa;&#x9;&#x9;&#x9;&#x9;in_low = angle_low[5];&#xa;&#x9;&#x9;&#x9;&#x9;in_heigh = angle_heigh[5]; &#xa;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;&#x9;default:&#x9;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;begin&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;in_low &lt;= 8'h0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;in_heigh &lt;= 8'h0;&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;end&#xa;&#x9;&#x9;endcase&#xa;&#x9;&#x9;reg_cal &lt;=  ~(input_id+8'h7+8'h1+in_heigh+in_low+time_heigh+time_low);&#xa;&#x9;&#x9;state_cal &lt;= S2 ;&#xa;&#x9;&#x9;end&#xa;&#x9;S2:&#xa;&#x9;&#x9;begin&#xa;&#x9;&#x9;reg_out_data[79:72] &lt;= fill_data; // 0101 0101&#xa;&#x9;&#x9;reg_out_data[71:64] &lt;= fill_data;// 0101 0101&#xa;&#x9;&#x9;reg_out_data[63:56] &lt;= reg_id;//&#xa;&#x9;&#x9;reg_out_data[55:48] &lt;= 8'b00000111;&#xa;&#x9;&#x9;reg_out_data[47:40] &lt;= 8'b00000001;&#xa;&#x9;&#x9;reg_out_data[39:32] &lt;= in_heigh;&#xa;&#x9;&#x9;reg_out_data[31:24] &lt;= in_low;&#xa;&#x9;&#x9;reg_out_data[23:16] &lt;= time_heigh;&#xa;&#x9;&#x9;reg_out_data[15:8] &lt;= time_low;&#xa;&#x9;&#x9;reg_out_data[7:0] &lt;= reg_cal;&#xa;&#x9;&#x9;state_cal &lt;= S3;&#xa;&#x9;&#x9;end&#xa;&#x9;S3:&#xa;&#x9;&#x9;begin&#xa;&#x9;&#x9;data_out &lt;= reg_out_data;&#x9;&#x9;&#xa;&#x9;&#x9;send_en_out &lt;= 1'b1;&#xa;&#x9;&#x9;state_cal &lt;= S0;&#xa;&#x9;&#x9;end&#xa;&#x9;endcase&#xa;&#x9;end &#xa;end&#xa;&#xa;reg return_valid;&#xa;//返回接受有效信号&#xa;always @(posedge Clk or negedge Rst_n)&#xa;begin&#xa;if(!Rst_n)&#xa;&#x9;return_valid &lt;= 1'b0;&#xa;else&#xa;&#x9;begin&#xa;&#x9;&#x9;if(input_id != 8'h0)&#xa;&#x9;&#x9;&#x9;return_valid &lt;= 1'b1;&#xa;&#x9;else&#xa;&#x9;&#x9;&#x9;return_valid &lt;= 1'b0;&#xa;&#x9;end&#xa;end&#xa;&#xa;task add_model;&#xa;&#x9;input [7:0] angle_low_tr;&#xa;&#x9;input [7:0] angle_heigh_tr;&#xa;&#x9;output [7:0] a_low;&#xa;&#x9;output [7:0] a_heigh;&#xa;&#x9;begin//加法 ??????????阻塞or非阻塞&#xa;&#x9;a_low = delta_angle_low + angle_low_tr;&#xa;&#x9;if (a_low &lt; angle_low_tr)&#xa;&#x9;&#x9;med_angle = angle_heigh_tr + 8'h1;&#xa;&#x9;a_heigh = med_angle + angle_heigh_tr;&#xa;&#x9;med_angle = 8'h0;&#xa;&#x9;end&#xa;endtask&#xa;&#xa;task sub_model;&#xa;&#x9;input [7:0] angle_low_tr;&#xa;&#x9;input [7:0] angle_heigh_tr;&#xa;&#x9;output [7:0] a_low;&#xa;&#x9;output [7:0] a_heigh;&#xa;&#x9;begin&#xa;&#x9;if (delta_angle_low &lt; angle_low_tr)&#xa;&#x9;&#x9;a_low = angle_low_tr - delta_angle_low;&#xa;&#x9;else &#xa;&#x9;&#x9;begin&#xa;&#x9;&#x9;a_low = 8'h0; &#xa;&#x9;&#x9;med_angle = angle_heigh_tr-8'h1;&#xa;&#x9;&#x9;end&#xa;&#x9;if (med_angle &lt; delta_angle_heigh)&#xa;&#x9;&#x9;a_heigh = 8'h0;&#xa;&#x9;else&#xa;&#x9;&#x9;a_heigh = med_angle - delta_angle_heigh;&#xa;&#x9;med_angle = 8'h0;&#xa;&#x9;end&#xa;endtask " Class="module" Color="#d3d3d3" Parent="0" Name="arm_cal_m" Include="" File="Current/arm_cal_m.model">
 <Port Height="20" Side="left" X="-0.0222222" Datatype="wire" Y="0.15" Datasize="1" Function="" Inout="input" Width="20" Color="#faebd7" Parent="arm_cal_m" Name="Clk"/>
 <Port Height="20" Side="left" X="-0.0222222" Datatype="wire" Y="0.316667" Datasize="1" Function="" Inout="input" Width="20" Color="#00ffff" Parent="arm_cal_m" Name="Rst_n"/>
 <Port Height="20" Side="left" X="-0.0222222" Datatype="wire" Y="0.65" Datasize="1" Function="" Inout="input" Width="20" Color="#7fffd4" Parent="arm_cal_m" Name="input_cmd"/>
 <Port Height="20" Side="right" X="0.977778" Datatype="reg" Y="0.231667" Datasize="80" Function="" Inout="output" Width="20" Color="#a52a2a" Parent="arm_cal_m" Name="data_out"/>
 <Port Height="20" Side="right" X="0.977778" Datatype="reg" Y="0.481667" Datasize="1" Function="" Inout="output" Width="20" Color="#f5f5dc" Parent="arm_cal_m" Name="send_en_out"/>
 <Port Height="20" Side="left" X="-0.0222222" Datatype="wire" Y="0.481667" Datasize="8" Function="" Inout="input" Width="20" Color="#ffe4c4" Parent="arm_cal_m" Name="input_id"/>
</Module>
